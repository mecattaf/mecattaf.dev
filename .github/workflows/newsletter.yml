name: Newsletter Automation

on:
  push:
    branches: [ main ]
    paths: [ 'content/blog/**' ]

jobs:
  newsletter:
    runs-on: ubuntu-latest
    
    # Only run if commit message contains [Newsletter] or [Draft]
    if: contains(github.event.head_commit.message, '[Newsletter]') || contains(github.event.head_commit.message, '[Draft]')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need previous commit to detect changes
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        npm install axios gray-matter
    
    - name: Process blog post and send newsletter
      env:
        CONVERTKIT_API_KEY: ${{ secrets.CONVERTKIT_API_KEY }}
        CONVERTKIT_API_SECRET: ${{ secrets.CONVERTKIT_API_SECRET }}
      run: |
        cat > newsletter-processor.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const axios = require('axios');
        const matter = require('gray-matter');

        async function main() {
          try {
            console.log('üöÄ Starting newsletter automation...');
            
            // Check commit message for action type
            const commitMessage = process.env.GITHUB_EVENT_HEAD_COMMIT_MESSAGE || '';
            const isDraft = commitMessage.includes('[Draft]');
            const isNewsletter = commitMessage.includes('[Newsletter]');
            
            if (!isDraft && !isNewsletter) {
              console.log('‚ùå No newsletter trigger found in commit message');
              return;
            }
            
            console.log(`üìù Mode: ${isDraft ? 'Draft' : 'Send Newsletter'}`);
            
            // Find the most recently modified blog post (excluding files starting with _)
            const blogDir = 'content/blog';
            const blogFiles = fs.readdirSync(blogDir)
              .filter(file => file.endsWith('.md') && !file.startsWith('_'))
              .map(file => {
                const filePath = path.join(blogDir, file);
                const stats = fs.statSync(filePath);
                return { file, path: filePath, mtime: stats.mtime };
              })
              .sort((a, b) => b.mtime - a.mtime);
            
            if (blogFiles.length === 0) {
              console.log('‚ùå No blog posts found');
              return;
            }
            
            const latestPost = blogFiles[0];
            console.log(`üìÑ Processing: ${latestPost.file}`);
            
            // Parse the blog post (Hugo uses TOML frontmatter with +++)
            const fileContent = fs.readFileSync(latestPost.path, 'utf8');
            
            let frontMatter = {};
            let content = fileContent;
            
            // Parse TOML frontmatter manually since gray-matter expects YAML by default
            const frontMatterMatch = fileContent.match(/^\+\+\+\n([\s\S]*?)\n\+\+\+\n([\s\S]*)$/);
            if (frontMatterMatch) {
              const frontMatterText = frontMatterMatch[1];
              content = frontMatterMatch[2];
              
              // Simple TOML parser for the fields we need
              frontMatterText.split('\n').forEach(line => {
                const match = line.match(/^(\w+)\s*=\s*"([^"]*)"$/);
                if (match) {
                  frontMatter[match[1]] = match[2];
                }
              });
            }
            
            // Convert markdown to plain text for email
            const emailContent = convertMarkdownToText(content);
            
            // Prepare newsletter data
            const subject = frontMatter.title || 'New Blog Post';
            const emailBody = emailContent;
            
            console.log(`üìß Subject: ${subject}`);
            console.log(`üìù Content length: ${emailContent.length} characters`);
            
            // Send to ConvertKit
            await sendToConvertKit(subject, emailBody, isDraft);
            
          } catch (error) {
            console.error('‚ùå Error:', error.message);
            process.exit(1);
          }
        }

        function convertMarkdownToText(markdown) {
          return markdown
            // Remove Hugo comments
            .replace(/<!--[\s\S]*?-->/g, '')
            // Remove Hugo shortcodes
            .replace(/\{\{[^}]+\}\}/g, '')
            // Convert headers to clean text with proper spacing using \r\n
            .replace(/^#{1}\s+(.+)$/gm, '\r\n\r\n$1\r\n' + '='.repeat(40) + '\r\n\r\n')
            .replace(/^#{2}\s+(.+)$/gm, '\r\n\r\n$1\r\n' + '-'.repeat(25) + '\r\n\r\n')
            .replace(/^#{3,6}\s+(.+)$/gm, '\r\n\r\n$1:\r\n\r\n')
            // Convert bold text (keep emphasis)
            .replace(/\*\*([^*]+)\*\*/g, '$1')
            // Convert italic text (keep emphasis)
            .replace(/\*([^*]+)\*/g, '$1')
            // Convert links to clean format on separate lines
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '$1 ($2)')
            // Convert reference-style links at the bottom
            .replace(/^\[([^\]]+)\]:\s*(.+)$/gm, '$1: $2')
            // Convert code blocks to indented text with clear separation
            .replace(/```[\s\S]*?```/g, (match) => {
              const code = match.replace(/```\w*\n?/g, '').replace(/```/g, '');
              return '\r\n\r\n' + code.split('\n').map(line => '    ' + line).join('\r\n') + '\r\n\r\n';
            })
            // Convert inline code (remove backticks)
            .replace(/`([^`]+)`/g, '$1')
            // Convert lists to properly spaced bullet points with explicit line breaks
            .replace(/^[\s]*[-*+]\s+(.+)$/gm, '\r\n‚Ä¢ $1\r\n')
            .replace(/^[\s]*\d+\.\s+(.+)$/gm, '\r\n‚Ä¢ $1\r\n')
            // Remove HTML tags
            .replace(/<[^>]*>/g, '')
            // Split paragraphs and join with explicit double line breaks
            .split(/\n\s*\n/)
            .map(paragraph => paragraph.trim().replace(/\n/g, ' '))
            .filter(paragraph => paragraph.length > 0)
            .join('\r\n\r\n')
            // Clean up any remaining newlines and replace with \r\n
            .replace(/\n+/g, '\r\n')
            // Clean up excessive line breaks
            .replace(/(\r\n){4,}/g, '\r\n\r\n\r\n')
            .replace(/[ \t]+$/gm, '') // Remove trailing spaces
            // Trim whitespace
            .trim();
        }

        async function sendToConvertKit(subject, content, isDraft) {
          const apiKey = process.env.CONVERTKIT_API_KEY;
          const apiSecret = process.env.CONVERTKIT_API_SECRET;
          
          if (!apiKey || !apiSecret) {
            throw new Error('ConvertKit API credentials not found');
          }
          
          // Create broadcast
          const broadcastData = {
            api_secret: apiSecret,
            subject: subject,
            content: content,
            description: `Newsletter: ${subject}`,
            public: !isDraft  // If draft, don't make public yet
          };
          
          console.log('üì§ Creating broadcast in ConvertKit...');
          
          const response = await axios.post(
            `https://api.convertkit.com/v3/broadcasts?api_key=${apiKey}`,
            broadcastData,
            {
              headers: {
                'Content-Type': 'application/json'
              }
            }
          );
          
          const broadcastId = response.data.broadcast.id;
          console.log(`‚úÖ Broadcast created with ID: ${broadcastId}`);
          
          if (!isDraft) {
            // Send the broadcast immediately
            console.log('üì¨ Sending newsletter...');
            
            await axios.post(
              `https://api.convertkit.com/v3/broadcasts/${broadcastId}/send?api_key=${apiKey}`,
              { api_secret: apiSecret },
              {
                headers: {
                  'Content-Type': 'application/json'
                }
              }
            );
            
            console.log('üéâ Newsletter sent successfully!');
          } else {
            console.log('üìù Draft created in ConvertKit for review');
            console.log(`üîó Review at: https://app.convertkit.com/broadcasts/${broadcastId}`);
          }
        }

        // Add commit message to environment
        const { execSync } = require('child_process');
        try {
          const commitMsg = execSync('git log -1 --pretty=%B', { encoding: 'utf8' }).trim();
          process.env.GITHUB_EVENT_HEAD_COMMIT_MESSAGE = commitMsg;
        } catch (e) {
          console.log('Could not get commit message, using GitHub event');
        }

        main();
        EOF
        
        node newsletter-processor.js
    
    - name: Cleanup
      run: rm -f newsletter-processor.js
